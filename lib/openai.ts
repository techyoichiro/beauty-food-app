import OpenAI from 'openai';

// OpenAI APIã‚­ãƒ¼ï¼ˆç’°å¢ƒå¤‰æ•°ã‹ã‚‰å–å¾—ï¼‰
const OPENAI_API_KEY = process.env.EXPO_PUBLIC_OPENAI_API_KEY;

if (!OPENAI_API_KEY || OPENAI_API_KEY === 'your-api-key-here') {
  throw new Error('Missing OpenAI API key. Please check your .env file.');
}

// OpenAIã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã®åˆæœŸåŒ–
export const openai = new OpenAI({
  apiKey: OPENAI_API_KEY,
  dangerouslyAllowBrowser: true, // React Native/Expoã§å¿…è¦
});

// ç¾å®¹ã‚«ãƒ†ã‚´ãƒªãƒ¼åˆ¥ã®è©³ç´°æƒ…å ±
const BEAUTY_CATEGORY_DETAILS = {
  skin_care: {
    name: 'ç¾è‚Œ',
    focus: 'ã‚³ãƒ©ãƒ¼ã‚²ãƒ³ç”Ÿæˆã€ãƒ“ã‚¿ãƒŸãƒ³Cãƒ»Eã€æŠ—é…¸åŒ–ç‰©è³ªã€ã‚»ãƒ©ãƒŸãƒ‰ã€ãƒ’ã‚¢ãƒ«ãƒ­ãƒ³é…¸ã®ææ–™',
    keywords: ['ãƒ“ã‚¿ãƒŸãƒ³C', 'ãƒ“ã‚¿ãƒŸãƒ³E', 'ã‚³ãƒ©ãƒ¼ã‚²ãƒ³', 'ã‚¢ã‚¹ã‚¿ã‚­ã‚µãƒ³ãƒãƒ³', 'ãƒªã‚³ãƒ”ãƒ³', 'ãƒ™ãƒ¼ã‚¿ã‚«ãƒ­ãƒ†ãƒ³'],
    adviceStyle: 'è‚Œã®ãƒãƒªãƒ»ãƒ„ãƒ¤ãƒ»é€æ˜æ„Ÿã‚’é‡è¦–ã—ãŸé£Ÿæçµ„ã¿åˆã‚ã›'
  },
  anti_aging: {
    name: 'ã‚¢ãƒ³ãƒã‚¨ã‚¤ã‚¸ãƒ³ã‚°',
    focus: 'æ´»æ€§é…¸ç´ é™¤å»ã€æŠ—é…¸åŒ–ä½œç”¨ã€ç´°èƒä¿®å¾©ã€DNAä¿è­·ã€è€åŒ–é˜²æ­¢',
    keywords: ['ãƒãƒªãƒ•ã‚§ãƒãƒ¼ãƒ«', 'ã‚«ãƒ†ã‚­ãƒ³', 'ã‚¢ãƒ³ãƒˆã‚·ã‚¢ãƒ‹ãƒ³', 'ãƒ¬ã‚¹ãƒ™ãƒ©ãƒˆãƒ­ãƒ¼ãƒ«', 'ã‚»ã‚µãƒŸãƒ³', 'ã‚¯ãƒ«ã‚¯ãƒŸãƒ³'],
    adviceStyle: 'ç´°èƒãƒ¬ãƒ™ãƒ«ã§ã®è€åŒ–é˜²æ­¢ã¨ä¿®å¾©ã‚’é‡è¦–ã—ãŸæ „é¤Šç´ '
  },
  detox: {
    name: 'ãƒ‡ãƒˆãƒƒã‚¯ã‚¹',
    focus: 'è‚æ©Ÿèƒ½ã‚µãƒãƒ¼ãƒˆã€è…¸å†…ç’°å¢ƒæ”¹å–„ã€è€å»ƒç‰©æ’å‡ºã€æ°´åˆ†ä»£è¬ä¿ƒé€²',
    keywords: ['é£Ÿç‰©ç¹Šç¶­', 'ã‚«ãƒªã‚¦ãƒ ', 'ã‚°ãƒ«ã‚¿ãƒã‚ªãƒ³', 'ç¡«é»„åŒ–åˆç‰©', 'ä¹³é…¸èŒ', 'ã‚ªãƒªã‚´ç³–'],
    adviceStyle: 'ä½“å†…æµ„åŒ–ã¨ä»£è¬ä¿ƒé€²ã‚’é‡è¦–ã—ãŸé£Ÿæé¸æŠ'
  },
  circulation: {
    name: 'è¡€è¡Œä¿ƒé€²',
    focus: 'è¡€æµæ”¹å–„ã€å†·ãˆæ€§æ”¹å–„ã€é…¸ç´ ãƒ»æ „é¤Šç´ ã®é‹æ¬åŠ¹ç‡å‘ä¸Š',
    keywords: ['é‰„åˆ†', 'ãƒ“ã‚¿ãƒŸãƒ³E', 'ãƒŠã‚¤ã‚¢ã‚·ãƒ³', 'ã‚«ãƒ—ã‚µã‚¤ã‚·ãƒ³', 'ã‚·ãƒ§ã‚¦ã‚¬ã‚ªãƒ¼ãƒ«', 'EPAãƒ»DHA'],
    adviceStyle: 'è¡€æµã¨ä½“æ¸©å‘ä¸Šã‚’é‡è¦–ã—ãŸæ¸©æ´»é£Ÿæ'
  },
  hair_nails: {
    name: 'é«ªãƒ»çˆªã®å¥åº·',
    focus: 'ã‚±ãƒ©ãƒãƒ³ç”Ÿæˆã€ã‚¿ãƒ³ãƒ‘ã‚¯è³ªåˆæˆã€ãƒŸãƒãƒ©ãƒ«è£œçµ¦ã€æ¯›é«ªæˆé•·ä¿ƒé€²',
    keywords: ['ã‚¿ãƒ³ãƒ‘ã‚¯è³ª', 'äºœé‰›', 'ãƒ“ã‚ªãƒãƒ³', 'ã‚·ã‚¹ãƒãƒ³', 'ãƒ¡ãƒã‚ªãƒ‹ãƒ³', 'ã‚±ã‚¤ç´ '],
    adviceStyle: 'é«ªã¨çˆªã®æ§‹é€ ææ–™ã¨ãªã‚‹æ „é¤Šç´ ã‚’é‡è¦–'
  }
};

// ç¾å®¹ã‚¹ã‚¿ã‚¤ãƒ«åˆ¥ã®èª¬æ˜æ·±åº¦
const BEAUTY_LEVEL_STYLES = {
  beginner: {
    name: 'åˆå¿ƒè€…',
    style: 'ã‚ã‹ã‚Šã‚„ã™ãç°¡æ½”ã«ã€åŸºæœ¬çš„ãªæ „é¤Šç´ ã®åŠ¹æœã‚’èª¬æ˜',
    example: 'ã€Œãƒ“ã‚¿ãƒŸãƒ³Cã¯ç¾è‚Œã«è‰¯ã„ã€'
  },
  intermediate: {
    name: 'ä¸­ç´šè€…',
    style: 'æ „é¤Šç´ ã®å…·ä½“çš„ãªåƒãã¨ç¾å®¹åŠ¹æœã®é–¢é€£ã‚’èª¬æ˜',
    example: 'ã€Œãƒ“ã‚¿ãƒŸãƒ³Cã¯ã‚³ãƒ©ãƒ¼ã‚²ãƒ³åˆæˆã‚’ä¿ƒé€²ã—ã€è‚Œã®ãƒãƒªã‚’ä¿ã¤ã€'
  },
  advanced: {
    name: 'ä¸Šç´šè€…',
    style: 'ç”ŸåŒ–å­¦çš„ãƒ¡ã‚«ãƒ‹ã‚ºãƒ ã¨ç§‘å­¦çš„æ ¹æ‹ ã‚’å«ã‚€è©³ç´°èª¬æ˜',
    example: 'ã€Œã‚¢ã‚¹ã‚³ãƒ«ãƒ“ãƒ³é…¸ãŒãƒ—ãƒ­ãƒªãƒ³ãƒ»ãƒªã‚¸ãƒ³ã®æ°´é…¸åŒ–ã‚’ä¿ƒé€²ã—ã‚³ãƒ©ãƒ¼ã‚²ãƒ³ä¸‰é‡ã‚‰ã›ã‚“æ§‹é€ ã‚’å®‰å®šåŒ–ã€'
  }
};

// ç¾å®¹ã‚«ãƒ†ã‚´ãƒªãƒ¼åˆ¥ã®ã‚¢ãƒ‰ãƒã‚¤ã‚¹ç”Ÿæˆ
const generateCategorySpecificAdvice = (categories: string[], level: string) => {
  const selectedCategories = categories.map(cat => BEAUTY_CATEGORY_DETAILS[cat as keyof typeof BEAUTY_CATEGORY_DETAILS]).filter(Boolean);
  const levelInfo = BEAUTY_LEVEL_STYLES[level as keyof typeof BEAUTY_LEVEL_STYLES] || BEAUTY_LEVEL_STYLES.intermediate;

  const focusAreas = selectedCategories.map(cat => cat.focus).join('ã€');
  const keywords = selectedCategories.flatMap(cat => cat.keywords).join('ã€');
  const adviceStyles = selectedCategories.map(cat => cat.adviceStyle).join('ã€');

  return {
    focusAreas,
    keywords,
    adviceStyles,
    levelStyle: levelInfo.style,
    categoryNames: selectedCategories.map(cat => cat.name).join('ãƒ»')
  };
};

// é£Ÿäº‹è§£æç”¨ã®ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆ
export const createFoodAnalysisPrompt = (userProfile: {
  beautyCategories: string[];
  beautyLevel: string;
}) => {
  const categoryInfo = generateCategorySpecificAdvice(userProfile.beautyCategories, userProfile.beautyLevel);
  
  return `
ã“ã®é£Ÿäº‹ç”»åƒã‚’è©³ç´°ã«åˆ†æã—ã¦ã€ä»¥ä¸‹ã®JSONå½¢å¼ã§å›ç­”ã—ã¦ãã ã•ã„ã€‚

ã€é£Ÿææ¤œå‡ºã®é‡è¦æŒ‡é‡ã€‘
1. å…·ä½“çš„ãªé£Ÿæåã‚’ç‰¹å®šã—ã¦ãã ã•ã„ï¼ˆä¾‹ï¼šã€Œé­šã€â†’ã€Œã‚µãƒã€ã€Œé®­ã€ã€Œãƒã‚°ãƒ­ã€ãªã©ï¼‰
2. é‡èœã¯ç¨®é¡ã‚’è©³ã—ãåˆ†æã—ã¦ãã ã•ã„ï¼ˆä¾‹ï¼šã€Œé‡èœã€â†’ã€Œç‰ã­ãã€ã€Œäººå‚ã€ã€Œãƒ”ãƒ¼ãƒãƒ³ã€ãªã©ï¼‰
3. èª¿ç†æ³•ã‚„æ–™ç†åã‚‚è€ƒæ…®ã—ã¦ãã ã•ã„ï¼ˆä¾‹ï¼šã€Œã‚«ãƒ¬ãƒ¼ã€ã€Œç‚’ã‚ç‰©ã€ã€Œç…®ç‰©ã€ãªã©ï¼‰
4. é¦™è¾›æ–™ã‚„ã‚½ãƒ¼ã‚¹ã€èª¿å‘³æ–™ã‚‚å¯èƒ½ãªé™ã‚Šæ¤œå‡ºã—ã¦ãã ã•ã„
5. éƒ¨åˆ†çš„ã«è¦‹ãˆã‚‹é£Ÿæã‚‚æ¨æ¸¬ã—ã¦å«ã‚ã¦ãã ã•ã„
6. ä¿¡é ¼åº¦ã¯æ§ãˆã‚ã«è¨­å®šã—ã€ä¸ç¢ºå®Ÿãªå ´åˆã¯0.6-0.8ç¨‹åº¦ã«ã—ã¦ãã ã•ã„
7. æ–™ç†ã®æ–‡åŒ–çš„èƒŒæ™¯ã‚’è€ƒæ…®ã—ã¦ãã ã•ã„ï¼ˆä¾‹ï¼šã‚¹ãƒªãƒ©ãƒ³ã‚«ã‚«ãƒ¬ãƒ¼ã€ã‚¿ã‚¤æ–™ç†ã€ã‚¤ã‚¿ãƒªã‚¢æ–™ç†ãªã©ï¼‰
8. å…¸å‹çš„ãªçµ„ã¿åˆã‚ã›ã®é£Ÿæã‚‚æ¨æ¸¬ã—ã¦å«ã‚ã¦ãã ã•ã„ï¼ˆä¾‹ï¼šã‚«ãƒ¬ãƒ¼ãªã‚‰ã‚³ã‚³ãƒŠãƒƒãƒ„ãƒŸãƒ«ã‚¯ã€ã‚¬ãƒ©ãƒ ãƒã‚µãƒ©ãªã©ï¼‰

ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«:
- ç¾å®¹ç›®æ¨™: ${categoryInfo.categoryNames}
- ç¾å®¹ãƒ¬ãƒ™ãƒ«: ${BEAUTY_LEVEL_STYLES[userProfile.beautyLevel as keyof typeof BEAUTY_LEVEL_STYLES]?.name || 'ä¸­ç´šè€…'}
- é‡ç‚¹ãƒ•ã‚©ãƒ¼ã‚«ã‚¹: ${categoryInfo.focusAreas}

ã€é‡è¦ã€‘ã‚¢ãƒ‰ãƒã‚¤ã‚¹ç”Ÿæˆã®æŒ‡é‡:
1. èª¬æ˜ãƒ¬ãƒ™ãƒ«: ${categoryInfo.levelStyle}
2. é‡è¦–ã™ã‚‹æ „é¤Šç´ : ${categoryInfo.keywords}
3. ã‚¢ãƒ‰ãƒã‚¤ã‚¹ã‚¹ã‚¿ã‚¤ãƒ«: ${categoryInfo.adviceStyles}

ä»¥ä¸‹ã®JSONå½¢å¼ã§å›ç­”ã—ã¦ãã ã•ã„:

{
  "detected_foods": [
    {
      "name": "å…·ä½“çš„ãªé£Ÿæåï¼ˆä¾‹ï¼šé®­ã®åˆ‡ã‚Šèº«ã€ç‰ã­ãã€ã‚³ã‚³ãƒŠãƒƒãƒ„ãƒŸãƒ«ã‚¯ã€ã‚¿ãƒ¼ãƒ¡ãƒªãƒƒã‚¯ç­‰ï¼‰",
      "category": "protein|carb|vegetable|fruit|fat|spice|sauce|other",
      "estimated_amount": "æ¨å®šé‡ï¼ˆä¾‹ï¼š100gã€1å€‹ã€å¤§ã•ã˜1ï¼‰",
      "confidence": 0.75
    }
  ],
  "nutrition_analysis": {
    "calories": æ¨å®šã‚«ãƒ­ãƒªãƒ¼æ•°å€¤,
    "protein": ã‚¿ãƒ³ãƒ‘ã‚¯è³ª(g),
    "carbohydrates": ç‚­æ°´åŒ–ç‰©(g),
    "fat": è„‚è³ª(g),
    "fiber": é£Ÿç‰©ç¹Šç¶­(g),
    "vitamins": {
      "vitamin_c": ãƒ“ã‚¿ãƒŸãƒ³C(mg),
      "vitamin_e": ãƒ“ã‚¿ãƒŸãƒ³E(mg),
      "vitamin_a": ãƒ“ã‚¿ãƒŸãƒ³A(Î¼g),
      "vitamin_b_complex": ãƒ“ã‚¿ãƒŸãƒ³Bç¾¤ç·åˆã‚¹ã‚³ã‚¢(1-10)
    },
    "minerals": {
      "iron": é‰„åˆ†(mg),
      "zinc": äºœé‰›(mg),
      "calcium": ã‚«ãƒ«ã‚·ã‚¦ãƒ (mg),
      "magnesium": ãƒã‚°ãƒã‚·ã‚¦ãƒ (mg)
    }
  },
  "beauty_score": {
    "skin_care": ç¾è‚Œã‚¹ã‚³ã‚¢(0-100),
    "anti_aging": ã‚¢ãƒ³ãƒã‚¨ã‚¤ã‚¸ãƒ³ã‚°ã‚¹ã‚³ã‚¢(0-100),
    "detox": ãƒ‡ãƒˆãƒƒã‚¯ã‚¹ã‚¹ã‚³ã‚¢(0-100),
    "circulation": è¡€è¡Œä¿ƒé€²ã‚¹ã‚³ã‚¢(0-100),
    "hair_nails": é«ªãƒ»çˆªå¥åº·ã‚¹ã‚³ã‚¢(0-100),
    "overall": ç·åˆç¾å®¹ã‚¹ã‚³ã‚¢(0-100)
  },
  "immediate_advice": "ä»Šã™ãã§ãã‚‹æ”¹å–„ææ¡ˆï¼ˆãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ç¾å®¹ç›®æ¨™ã€Œ${categoryInfo.categoryNames}ã€ã«ç‰¹åŒ–ï¼‰",
  "next_meal_advice": "æ¬¡å›å‘ã‘æ”¹å–„ææ¡ˆï¼ˆãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ç¾å®¹ç›®æ¨™ã€Œ${categoryInfo.categoryNames}ã€ã«ç‰¹åŒ–ï¼‰",
  "beauty_benefits": [
    "ä»Šå›ã®é£Ÿäº‹ã§æœŸå¾…ã§ãã‚‹ç¾å®¹åŠ¹æœ1ï¼ˆ${categoryInfo.categoryNames}è¦³ç‚¹ï¼‰",
    "ä»Šå›ã®é£Ÿäº‹ã§æœŸå¾…ã§ãã‚‹ç¾å®¹åŠ¹æœ2ï¼ˆ${categoryInfo.categoryNames}è¦³ç‚¹ï¼‰",
    "ä»Šå›ã®é£Ÿäº‹ã§æœŸå¾…ã§ãã‚‹ç¾å®¹åŠ¹æœ3ï¼ˆ${categoryInfo.categoryNames}è¦³ç‚¹ï¼‰"
  ]
}

ã€ã‚¢ãƒ‰ãƒã‚¤ã‚¹ç”Ÿæˆã®å…·ä½“ä¾‹ã€‘
ç¾è‚Œé‡è¦–ã®å ´åˆ:
- immediate_advice: "ãƒ¬ãƒ¢ãƒ³ã‚’çµã£ã¦ãƒ“ã‚¿ãƒŸãƒ³Cã‚’ãƒ—ãƒ©ã‚¹ï¼é®­ã®ã‚¢ã‚¹ã‚¿ã‚­ã‚µãƒ³ãƒãƒ³ã¨ã®ç›¸ä¹—åŠ¹æœã§ç¾è‚ŒåŠ›ã‚¢ãƒƒãƒ—"
- next_meal_advice: "æ¬¡å›ã¯ãƒˆãƒãƒˆã‚µãƒ©ãƒ€ã‚’è¿½åŠ ã€‚ãƒªã‚³ãƒ”ãƒ³ã§ã‚³ãƒ©ãƒ¼ã‚²ãƒ³ç”Ÿæˆã‚’ã•ã‚‰ã«ä¿ƒé€²ã—ã¾ã—ã‚‡ã†"

ã‚¢ãƒ³ãƒã‚¨ã‚¤ã‚¸ãƒ³ã‚°é‡è¦–ã®å ´åˆ:
- immediate_advice: "ç·‘èŒ¶ã¨ä¸€ç·’ã«æ‘‚å–ã™ã‚‹ã¨æŠ—é…¸åŒ–ä½œç”¨ãŒå€å¢—ï¼ã‚«ãƒ†ã‚­ãƒ³ãŒæ´»æ€§é…¸ç´ ã‚’é™¤å»ã—ã¾ã™"
- next_meal_advice: "ãƒŠãƒƒãƒ„é¡ï¼ˆç‰¹ã«ã‚¢ãƒ¼ãƒ¢ãƒ³ãƒ‰ï¼‰ã‚’é–“é£Ÿã«ã€‚ãƒ“ã‚¿ãƒŸãƒ³Eã§ç´°èƒã®è€åŒ–ã‚’é˜²ãã¾ã—ã‚‡ã†"

ãƒ‡ãƒˆãƒƒã‚¯ã‚¹é‡è¦–ã®å ´åˆ:
- immediate_advice: "é£Ÿå¾Œã«ç™½æ¹¯ã‚’é£²ã‚“ã§ä»£è¬ã‚¢ãƒƒãƒ—ï¼æ¶ˆåŒ–ã‚’åŠ©ã‘ã¦è€å»ƒç‰©ã®æ’å‡ºã‚’ä¿ƒé€²"
- next_meal_advice: "æ˜æ—¥ã®æœé£Ÿã«ã‚¢ãƒœã‚«ãƒ‰ã‚’ãƒ—ãƒ©ã‚¹ã€‚é£Ÿç‰©ç¹Šç¶­ã§è…¸å†…ç’°å¢ƒã‚’æ•´ãˆã¾ã—ã‚‡ã†"

è¡€è¡Œä¿ƒé€²é‡è¦–ã®å ´åˆ:
- immediate_advice: "ç”Ÿå§œã‚’ã™ã‚ŠãŠã‚ã—ã¦è¿½åŠ ï¼ä½“ã‚’æ¸©ã‚ã¦è¡€æµæ”¹å–„åŠ¹æœã‚’é«˜ã‚ã¾ã™"
- next_meal_advice: "æ¬¡å›ã¯èµ¤èº«è‚‰ã‚„å°æ¾èœã§é‰„åˆ†è£œçµ¦ã€‚è²§è¡€äºˆé˜²ã§è¡€è¡Œã‚’ã•ã‚‰ã«è‰¯ãã—ã¾ã—ã‚‡ã†"

é«ªãƒ»çˆªé‡è¦–ã®å ´åˆ:
- immediate_advice: "ã”ã¾ã‚’ãµã‚Šã‹ã‘ã¦äºœé‰›ã¨ãƒ“ã‚ªãƒãƒ³ã‚’ãƒ—ãƒ©ã‚¹ï¼é«ªã®æˆé•·ã«å¿…è¦ãªæ „é¤Šç´ ã§ã™"
- next_meal_advice: "åµæ–™ç†ã‚’è¿½åŠ ã—ã¦ã‚¿ãƒ³ãƒ‘ã‚¯è³ªå¼·åŒ–ã€‚é«ªã¨çˆªã®ä¸»æˆåˆ†ã‚±ãƒ©ãƒãƒ³ã®ææ–™ã§ã™"

ã€é£Ÿææ¤œå‡ºã®å…·ä½“ä¾‹ã€‘
ã‚«ãƒ¬ãƒ¼æ–™ç†ã®å ´åˆ:
- âŒ æ‚ªã„ä¾‹: "é­š", "é‡èœ", "ã”é£¯", "ã‚¹ãƒ¼ãƒ—"
- âœ… è‰¯ã„ä¾‹: "ãƒã‚°ãƒ­ã®åˆºèº«", "ç‰ã­ã", "äººå‚", "ãƒ”ãƒ¼ãƒãƒ³", "ã‚³ã‚³ãƒŠãƒƒãƒ„ãƒŸãƒ«ã‚¯", "ã‚¿ãƒ¼ãƒ¡ãƒªãƒƒã‚¯", "ã‚¯ãƒŸãƒ³", "ã‚³ãƒªã‚¢ãƒ³ãƒ€ãƒ¼", "ã‚¬ãƒ©ãƒ ãƒã‚µãƒ©", "ãƒã‚¹ãƒãƒ†ã‚£ãƒ©ã‚¤ã‚¹", "ã‚«ãƒ¬ãƒ¼ãƒ«ãƒ¼"

ã‚µãƒ©ãƒ€ã®å ´åˆ:
- âŒ æ‚ªã„ä¾‹: "é‡èœ", "ãƒ‰ãƒ¬ãƒƒã‚·ãƒ³ã‚°"
- âœ… è‰¯ã„ä¾‹: "ãƒ¬ã‚¿ã‚¹", "ãƒˆãƒãƒˆ", "ãã‚…ã†ã‚Š", "ã‚¢ãƒœã‚«ãƒ‰", "ã‚ªãƒªãƒ¼ãƒ–ã‚ªã‚¤ãƒ«", "ãƒãƒ«ã‚µãƒŸã‚³é…¢", "ãƒ‘ãƒ«ãƒ¡ã‚¶ãƒ³ãƒãƒ¼ã‚º", "ã‚¯ãƒ«ãƒˆãƒ³"

é‡è¦äº‹é …:
- æœ‰åŠ¹ãªJSONã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã®ã¿ã‚’è¿”ã—ã¦ãã ã•ã„
- æ—¥æœ¬èªã®ãƒ†ã‚­ã‚¹ãƒˆã‚’å«ã‚ã¦ãã ã•ã„
- æ•°å€¤ã¯å…·ä½“çš„ã«ç®—å‡ºã—ã¦ãã ã•ã„
- ç¾å®¹ã‚¹ã‚³ã‚¢ã¯ç§‘å­¦çš„æ ¹æ‹ ã«åŸºã¥ã„ã¦ç®—å‡ºã—ã¦ãã ã•ã„
- ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ç¾å®¹ç›®æ¨™ã«ç‰¹åŒ–ã—ãŸã‚¢ãƒ‰ãƒã‚¤ã‚¹ã‚’ç”Ÿæˆã—ã¦ãã ã•ã„
- èª¬æ˜ãƒ¬ãƒ™ãƒ«ã¯ã€Œ${categoryInfo.levelStyle}ã€ã«åˆã‚ã›ã¦ãã ã•ã„
- beauty_benefitsã¯ã€Œä»Šå›ã®é£Ÿäº‹ã‚’æ‘‚å–ã™ã‚‹ã“ã¨ã§æœŸå¾…ã§ãã‚‹å…·ä½“çš„ãªç¾å®¹åŠ¹æœã€ã‚’è¨˜è¼‰ã—ã¦ãã ã•ã„
- ç¾å®¹åŠ¹æœã¯çŸ­æœŸçš„ï¼ˆæ•°æ™‚é–“ã€œæ•°æ—¥ï¼‰ã§å®Ÿæ„Ÿã§ãã‚‹ã‚‚ã®ã¨ä¸­é•·æœŸçš„ï¼ˆæ•°é€±é–“ã€œæ•°ãƒ¶æœˆï¼‰ãªã‚‚ã®ã®ä¸¡æ–¹ã‚’å«ã‚ã¦ãã ã•ã„
- é£Ÿæåã¯å¯èƒ½ãªé™ã‚Šå…·ä½“çš„ã«ç‰¹å®šã—ã¦ãã ã•ã„ï¼ˆæ›–æ˜§ãªã€Œé­šã€ã€Œé‡èœã€ã§ã¯ãªãã€Œã‚µãƒã€ã€Œç‰ã­ãã€ãªã©ï¼‰
`;
};

// é£Ÿã¹ç‰©ä»¥å¤–ã®ç‰©ä½“ã«å¯¾ã™ã‚‹ãƒ¦ãƒ¼ãƒ¢ãƒ©ã‚¹ãªãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
const NON_FOOD_MESSAGES = {
  person: [
    "ãˆï¼ï¼ã“ã‚Œã¯äººé–“...ã§ã™ã‚ˆã­ï¼Ÿï¼Ÿã¾ã•ã‹é£Ÿã¹ã¦ãªã„ã§ã™ã‚ˆã­...",
    "äººé–“ã¯ç¾å®¹é£Ÿæã§ã¯ã‚ã‚Šã¾ã›ã‚“ã‚ˆï¼ğŸ˜…",
    "ãŠå‹é”ã®å†™çœŸã§ã™ã‹ï¼Ÿç¾å®¹åŠ¹æœã¯...æ¸¬å®šä¸èƒ½ã§ã™ï¼"
  ],
  animal: [
    "çŒ«ã¡ã‚ƒã‚“ã¯åˆ¤å®šã§ãã¾ã›ã‚“ã‚ˆï¼ğŸ±",
    "ã‚ã‚“ã¡ã‚ƒã‚“ã¯å¯æ„›ã„ã§ã™ãŒã€ç¾å®¹ã‚¹ã‚³ã‚¢ã¯å‡ºã›ã¾ã›ã‚“ï¼ğŸ•",
    "å‹•ç‰©ã•ã‚“ã®ç¾å®¹åŠ¹æœã¯...æ„›ã§ã‚‹ã“ã¨ã§ã—ã‚‡ã†ã‹ï¼ŸğŸ’•"
  ],
  electronics: [
    "ãƒ‘ã‚½ã‚³ãƒ³ã¯å›ºãã¦é£Ÿã¹ã‚‹ã®ã«ã¯å‘ã„ã¦ã¾ã›ã‚“ã­...",
    "ã‚¹ãƒãƒ›ã®ã‚«ãƒ­ãƒªãƒ¼ã¯0kcalã§ã™ãŒã€æ „é¤Šä¾¡ã‚‚0ã§ã™ğŸ“±",
    "é›»å­æ©Ÿå™¨ã®ç¾å®¹åŠ¹æœã¯...ãƒ–ãƒ«ãƒ¼ãƒ©ã‚¤ãƒˆã‚«ãƒƒãƒˆã§ã—ã‚‡ã†ã‹ï¼Ÿ"
  ],
  furniture: [
    "æ¤…å­ã¯åº§ã‚‹ã‚‚ã®ã§ã‚ã£ã¦ã€é£Ÿã¹ã‚‹ã‚‚ã®ã§ã¯ã‚ã‚Šã¾ã›ã‚“ï¼",
    "ãƒ†ãƒ¼ãƒ–ãƒ«ã®æœ¨æã¯é£Ÿç‰©ç¹Šç¶­è±Šå¯Œã§ã™ãŒ...ãŠã™ã™ã‚ã—ã¾ã›ã‚“ğŸ˜…",
    "å®¶å…·ã®ç¾å®¹åŠ¹æœã¯ã€ãŠéƒ¨å±‹ãŒç¶ºéº—ã«ãªã‚‹ã“ã¨ã§ã—ã‚‡ã†ã‹ï¼Ÿ"
  ],
  vehicle: [
    "è»Šã¯é‰„åˆ†è±Šå¯Œã§ã™ãŒã€æ¶ˆåŒ–ã«æ‚ªãã†ã§ã™ğŸš—",
    "è‡ªè»¢è»Šã®ã‚«ãƒ­ãƒªãƒ¼æ¶ˆè²»åŠ¹æœã¯ã‚ã‚Šã¾ã™ãŒã€é£Ÿã¹ç‰©ã§ã¯ã‚ã‚Šã¾ã›ã‚“ï¼",
    "ä¹—ã‚Šç‰©ã®ç¾å®¹åŠ¹æœã¯...ç§»å‹•ã«ã‚ˆã‚‹é‹å‹•ã§ã—ã‚‡ã†ã‹ï¼Ÿ"
  ],
  nature: [
    "ãŠèŠ±ã¯ç¾ã—ã„ã§ã™ãŒã€é£Ÿç”¨èŠ±ã§ãªã„é™ã‚Šç¾å®¹è§£æã§ãã¾ã›ã‚“ğŸŒ¸",
    "æœ¨ã‚„çŸ³ã®ç¾å®¹åŠ¹æœã¯...è‡ªç„¶ã«ç™’ã•ã‚Œã‚‹ã“ã¨ã§ã—ã‚‡ã†ã‹ï¼Ÿ",
    "æ™¯è‰²ã¯å¿ƒã®æ „é¤Šã«ãªã‚Šã¾ã™ãŒã€ã‚«ãƒ­ãƒªãƒ¼è¨ˆç®—ã¯ã§ãã¾ã›ã‚“ï¼"
  ],
  object: [
    "ã“ã‚Œã¯...é£Ÿã¹ç‰©ã§ã¯ãªã„ã‚ˆã†ã§ã™ã­ï¼ŸğŸ¤”",
    "ç¾å®¹è§£æã«ã¯é£Ÿäº‹ã®å†™çœŸãŒå¿…è¦ã§ã™ï¼",
    "ã“ã®ç‰©ä½“ã®æ „é¤Šä¾¡ã¯...æ¸¬å®šä¸èƒ½ã§ã™ï¼"
  ],
  unclear: [
    "ã†ã€œã‚“ã€ã“ã‚ŒãŒä½•ãªã®ã‹ã‚ˆãã‚ã‹ã‚Šã¾ã›ã‚“ğŸ¤·â€â™€ï¸",
    "ã‚‚ã—ã‹ã—ã¦ã€ã¨ã¦ã‚‚çã—ã„é£Ÿæã§ã—ã‚‡ã†ã‹ï¼Ÿ",
    "ç”»åƒãŒã¼ã‚„ã‘ã¦ã„ã‚‹ã‹ã€é£Ÿã¹ç‰©ä»¥å¤–ã®ã‚ˆã†ã§ã™"
  ]
};

// é£Ÿã¹ç‰©åˆ¤å®šç”¨ã®ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ
export const createFoodDetectionPrompt = () => {
  return `
ã“ã®ç”»åƒã‚’è¦‹ã¦ã€é£Ÿã¹ç‰©ï¼ˆé£Ÿäº‹ã€æ–™ç†ã€é£Ÿæã€é£²ã¿ç‰©ã€ãŠè“å­ãªã©ï¼‰ãŒå«ã¾ã‚Œã¦ã„ã‚‹ã‹ã‚’åˆ¤å®šã—ã¦ãã ã•ã„ã€‚

ä»¥ä¸‹ã®JSONå½¢å¼ã§å›ç­”ã—ã¦ãã ã•ã„:

{
  "is_food": true/false,
  "detected_object": "person|animal|electronics|furniture|vehicle|nature|object|unclear",
  "confidence": 0.95,
  "description": "ç”»åƒã«å†™ã£ã¦ã„ã‚‹ã‚‚ã®ã®ç°¡æ½”ãªèª¬æ˜ï¼ˆæ—¥æœ¬èªï¼‰"
}

åˆ¤å®šåŸºæº–:
- is_food: true = é£Ÿã¹ç‰©ã€æ–™ç†ã€é£Ÿæã€é£²ã¿ç‰©ã€ãŠè“å­ãªã©é£Ÿäº‹ã«é–¢é€£ã™ã‚‹ã‚‚ã®
- is_food: false = äººã€å‹•ç‰©ã€é›»å­æ©Ÿå™¨ã€å®¶å…·ã€ä¹—ã‚Šç‰©ã€è‡ªç„¶ã€ãã®ä»–ã®ç‰©ä½“

detected_object ã®åˆ†é¡:
- person: äººé–“ã€é¡”ã€ä½“ã®ä¸€éƒ¨
- animal: å‹•ç‰©ã€ãƒšãƒƒãƒˆã€æ˜†è™«ãªã©
- electronics: ã‚¹ãƒãƒ›ã€ãƒ‘ã‚½ã‚³ãƒ³ã€ãƒ†ãƒ¬ãƒ“ã€é›»å­æ©Ÿå™¨
- furniture: æ¤…å­ã€ãƒ†ãƒ¼ãƒ–ãƒ«ã€ãƒ™ãƒƒãƒ‰ã€å®¶å…·
- vehicle: è»Šã€è‡ªè»¢è»Šã€é›»è»Šã€ä¹—ã‚Šç‰©
- nature: èŠ±ã€æœ¨ã€çŸ³ã€é¢¨æ™¯ã€è‡ªç„¶ç‰©
- object: ãã®ä»–ã®ç‰©ä½“ã€é“å…·ã€å»ºç‰©ãªã©
- unclear: åˆ¤åˆ¥å›°é›£ã€ã¼ã‚„ã‘ã¦ã„ã‚‹ã€æš—ã„

é‡è¦: æœ‰åŠ¹ãªJSONã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã®ã¿ã‚’è¿”ã—ã¦ãã ã•ã„ã€‚
`;
};

// é£Ÿã¹ç‰©ä»¥å¤–ã®å ´åˆã®ãƒ¦ãƒ¼ãƒ¢ãƒ©ã‚¹ãªãƒ¬ã‚¹ãƒãƒ³ã‚¹ç”Ÿæˆ
export const generateNonFoodResponse = (detectedObject: string): any => {
  const category = detectedObject as keyof typeof NON_FOOD_MESSAGES;
  const messages = NON_FOOD_MESSAGES[category] || NON_FOOD_MESSAGES.object;
  const randomMessage = messages[Math.floor(Math.random() * messages.length)];
  
  return {
    is_food: false,
    detected_object: detectedObject,
    humorous_message: randomMessage,
    suggestion: "ç¾å®¹åŠ¹æœã‚’åˆ†æã™ã‚‹ã«ã¯ã€é£Ÿäº‹ã‚„é£Ÿæã®å†™çœŸã‚’æ’®å½±ã—ã¦ãã ã•ã„ã­ï¼ğŸ“¸âœ¨",
    detected_foods: [],
    nutrition_analysis: {
      calories: 0,
      protein: 0,
      carbohydrates: 0,
      fat: 0,
      fiber: 0,
      vitamins: {
        vitamin_c: 0,
        vitamin_e: 0,
        vitamin_a: 0,
        vitamin_b_complex: 0
      },
      minerals: {
        iron: 0,
        zinc: 0,
        calcium: 0,
        magnesium: 0
      }
    },
    beauty_score: {
      skin_care: 0,
      anti_aging: 0,
      detox: 0,
      circulation: 0,
      hair_nails: 0,
      overall: 0
    },
    immediate_advice: "ã¾ãšã¯é£Ÿäº‹ã®å†™çœŸã‚’æ’®å½±ã—ã¦ã¿ã¾ã—ã‚‡ã†ï¼",
    next_meal_advice: "æ¬¡å›ã¯ç¾å‘³ã—ãã†ãªæ–™ç†ã®å†™çœŸã‚’ãŠå¾…ã¡ã—ã¦ã„ã¾ã™ğŸ½ï¸",
    beauty_benefits: [
      "é£Ÿäº‹ã®å†™çœŸã‚’æ’®ã‚‹ã“ã¨ã§ã€é£Ÿç”Ÿæ´»ã¸ã®æ„è­˜ãŒé«˜ã¾ã‚Šã¾ã™",
      "ç¾å®¹ã«è‰¯ã„é£Ÿæã‚’æ„è­˜çš„ã«é¸ã¶ãã£ã‹ã‘ã«ãªã‚Šã¾ã™",
      "æ „é¤Šãƒãƒ©ãƒ³ã‚¹ã‚’è€ƒãˆã‚‹ç¿’æ…£ãŒèº«ã«ã¤ãã¾ã™"
    ]
  };
};

// ç”»åƒã‚’Base64ã«å¤‰æ›ã™ã‚‹é–¢æ•°
const convertImageToBase64 = async (imageUri: string): Promise<string> => {
  try {
    if (imageUri.startsWith('data:')) {
      // æ—¢ã«Base64ã®å ´åˆã¯ãã®ã¾ã¾è¿”ã™
      return imageUri;
    }
    
    // React Nativeã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚·ã‚¹ãƒ†ãƒ ã‚’ä½¿ç”¨ã—ã¦Base64å¤‰æ›
    const FileSystem = await import('expo-file-system');
    const base64 = await FileSystem.readAsStringAsync(imageUri, {
      encoding: FileSystem.EncodingType.Base64,
    });
    return `data:image/jpeg;base64,${base64}`;
  } catch (error) {
    console.error('Base64å¤‰æ›ã‚¨ãƒ©ãƒ¼:', error);
    throw new Error('ç”»åƒã®å¤‰æ›ã«å¤±æ•—ã—ã¾ã—ãŸ');
  }
};

// é£Ÿã¹ç‰©åˆ¤å®šã‚’è¡Œã†é–¢æ•°
export const detectFoodInImage = async (imageUri: string): Promise<{
  isFood: boolean;
  detectedObject?: string;
  confidence?: number;
  description?: string;
}> => {
  try {
    console.log('OpenAIé£Ÿã¹ç‰©åˆ¤å®šAPIå‘¼ã³å‡ºã—é–‹å§‹');
    
    // ç”»åƒã‚’Base64ã«å¤‰æ›
    const base64Image = await convertImageToBase64(imageUri);
    console.log('Base64å¤‰æ›å®Œäº†');
    
    const response = await openai.chat.completions.create({
      model: "gpt-4o-mini",
      messages: [
        {
          role: "system",
          content: "ã‚ãªãŸã¯ç”»åƒåˆ¤å®šã®å°‚é–€å®¶ã§ã™ã€‚å¿…ãšæœ‰åŠ¹ãªJSONå½¢å¼ã§ã®ã¿å›ç­”ã—ã¦ãã ã•ã„ã€‚Markdownã‚„ãã®ä»–ã®å½¢å¼ã¯ä½¿ç”¨ã›ãšã€ç´”ç²‹ãªJSONã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã®ã¿ã‚’è¿”ã—ã¦ãã ã•ã„ã€‚"
        },
        {
          role: "user",
          content: [
            {
              type: "text",
              text: createFoodDetectionPrompt()
            },
            {
              type: "image_url",
              image_url: {
                url: base64Image,
              },
            },
          ],
        },
      ],
      max_tokens: 200,
      response_format: { type: "json_object" }
    });

    const content = response.choices[0]?.message?.content;
    if (!content) {
      throw new Error('OpenAI API response is empty');
    }

    console.log('OpenAIé£Ÿã¹ç‰©åˆ¤å®šAPIç”Ÿãƒ¬ã‚¹ãƒãƒ³ã‚¹:', content);
    
    // Markdownã®ã‚³ãƒ¼ãƒ‰ãƒ–ãƒ­ãƒƒã‚¯ã‚’é™¤å»
    let cleanedContent = content.trim();
    if (cleanedContent.startsWith('```json')) {
      cleanedContent = cleanedContent.replace(/^```json\s*/, '').replace(/\s*```$/, '');
    } else if (cleanedContent.startsWith('```')) {
      cleanedContent = cleanedContent.replace(/^```\s*/, '').replace(/\s*```$/, '');
    }
    
    console.log('ã‚¯ãƒªãƒ¼ãƒ‹ãƒ³ã‚°å¾Œã®ãƒ¬ã‚¹ãƒãƒ³ã‚¹:', cleanedContent);
    const result = JSON.parse(cleanedContent);
    console.log('ãƒ‘ãƒ¼ã‚¹å¾Œã®åˆ¤å®šçµæœ:', result);
    
    return {
      isFood: result.is_food,
      detectedObject: result.detected_object,
      confidence: result.confidence,
      description: result.description
    };
    
  } catch (error) {
    console.error('Food detection error:', error);
    // ã‚¨ãƒ©ãƒ¼ã®å ´åˆã¯é£Ÿã¹ç‰©ä»¥å¤–ã¨ã—ã¦å‡¦ç†ï¼ˆå®‰å…¨å´ã«å€’ã™ï¼‰
    return {
      isFood: false,
      detectedObject: 'unclear',
      confidence: 0.5,
      description: 'åˆ¤å®šã§ãã¾ã›ã‚“ã§ã—ãŸ'
    };
  }
};

export default openai; 