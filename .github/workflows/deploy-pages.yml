name: Deploy to GitHub Pages

on:
  push:
    branches: [ main ]

permissions:
  contents: read
  pages: write
  id-token: write

concurrency:
  group: "pages"
  cancel-in-progress: false

jobs:
  build:
    environment:
      name: github-pages
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
      
      - name: Setup Pages
        uses: actions/configure-pages@v4
      
      - name: Build support page with environment variables
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
        run: |
          echo "=== ç’°å¢ƒå¤‰æ•°ãƒ‡ãƒãƒƒã‚° ==="
          echo "SLACK_WEBHOOK_URL is set: $([ -n "$SLACK_WEBHOOK_URL" ] && echo 'YES' || echo 'NO')"
          echo "SLACK_WEBHOOK_URL length: ${#SLACK_WEBHOOK_URL}"
          echo "SLACK_WEBHOOK_URL starts with: ${SLACK_WEBHOOK_URL:0:30}..."
          echo ""
          
          # ç’°å¢ƒå¤‰æ•°ãŒè¨­å®šã•ã‚Œã¦ã„ã‚‹ã‹ç¢ºèª
          if [ -z "$SLACK_WEBHOOK_URL" ]; then
            echo "âŒ Error: SLACK_WEBHOOK_URL is not set"
            exit 1
          fi
          
          echo "=== ãƒ•ã‚¡ã‚¤ãƒ«ç½®æ›å‰ ==="
          head -10 support-page/config.js
          echo ""
          
          # ã‚ˆã‚Šç²¾å¯†ãªç½®æ›å‡¦ç†ï¼ˆè¨­å®šã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆå†…ã®è¡Œã®ã¿ï¼‰
          echo "ğŸ”„ ç½®æ›å®Ÿè¡Œä¸­..."
          cp support-page/config.js support-page/config.js.backup
          
          # sedã§ç‰¹å®šã®è¡Œã®ã¿ç½®æ›
          sed -i "s|SLACK_WEBHOOK_URL: 'REPLACE_WITH_ACTUAL_WEBHOOK_URL'|SLACK_WEBHOOK_URL: '$SLACK_WEBHOOK_URL'|g" support-page/config.js
          
          echo "=== ãƒ•ã‚¡ã‚¤ãƒ«ç½®æ›å¾Œ ==="
          head -10 support-page/config.js
          echo ""
          
          # ç½®æ›ãŒæˆåŠŸã—ãŸã‹ç¢ºèª
          if grep -q "SLACK_WEBHOOK_URL: 'REPLACE_WITH_ACTUAL_WEBHOOK_URL'" support-page/config.js; then
            echo "âŒ ã‚¨ãƒ©ãƒ¼: ç½®æ›ãŒå®Œäº†ã—ã¦ã„ã¾ã›ã‚“"
            echo "--- ç½®æ›å¯¾è±¡ãŒè¦‹ã¤ã‹ã£ãŸè¡Œ ---"
            grep -n "SLACK_WEBHOOK_URL: 'REPLACE_WITH_ACTUAL_WEBHOOK_URL'" support-page/config.js
            exit 1
          else
            echo "âœ… ç½®æ›æˆåŠŸï¼"
          fi
          
          # æ§‹æ–‡ãƒã‚§ãƒƒã‚¯
          echo "=== JavaScriptã®æ§‹æ–‡ãƒã‚§ãƒƒã‚¯ ==="
          if node -c support-page/config.js; then
            echo "âœ… JavaScriptæ§‹æ–‡ã¯æ­£å¸¸ã§ã™"
          else
            echo "âŒ JavaScriptæ§‹æ–‡ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ"
            echo "--- ã‚¨ãƒ©ãƒ¼ã®è©³ç´° ---"
            node -c support-page/config.js
            exit 1
          fi
          
          # æœ€çµ‚ç¢ºèª
          echo "=== æœ€çµ‚ç¢ºèª ==="
          if grep -q "https://hooks.slack.com" support-page/config.js; then
            echo "âœ… Webhook URL ãŒæ­£ã—ãè¨­å®šã•ã‚Œã¦ã„ã¾ã™"
          else
            echo "âŒ Webhook URL ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“"
            echo "--- è¨­å®šè¡Œã®ç¢ºèª ---"
            grep -A 2 -B 2 "SLACK_WEBHOOK_URL" support-page/config.js
          fi
          
          # ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ãƒ•ã‚¡ã‚¤ãƒ«ã‚’å‰Šé™¤
          rm support-page/config.js.backup
      
      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: '.'

  deploy:
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    runs-on: ubuntu-latest
    needs: build
    steps:
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4 