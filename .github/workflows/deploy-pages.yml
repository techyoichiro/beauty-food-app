name: Deploy to GitHub Pages

on:
  push:
    branches: [ main ]

permissions:
  contents: read
  pages: write
  id-token: write

concurrency:
  group: "pages"
  cancel-in-progress: false

jobs:
  build:
    environment:
      name: github-pages
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
      
      - name: Setup Pages
        uses: actions/configure-pages@v4
      
      - name: Build support page with environment variables
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
        run: |
          echo "=== ç’°å¢ƒå¤‰æ•°ãƒ‡ãƒãƒƒã‚° ==="
          echo "SLACK_WEBHOOK_URL is set: $([ -n "$SLACK_WEBHOOK_URL" ] && echo 'YES' || echo 'NO')"
          echo "SLACK_WEBHOOK_URL length: ${#SLACK_WEBHOOK_URL}"
          echo "SLACK_WEBHOOK_URL starts with: ${SLACK_WEBHOOK_URL:0:30}..."
          echo ""
          
          # ç’°å¢ƒå¤‰æ•°ãŒè¨­å®šã•ã‚Œã¦ã„ã‚‹ã‹ç¢ºèª
          if [ -z "$SLACK_WEBHOOK_URL" ]; then
            echo "âŒ Error: SLACK_WEBHOOK_URL is not set"
            exit 1
          fi
          
          echo "=== ãƒ•ã‚¡ã‚¤ãƒ«ç½®æ›å‰ ==="
          head -5 support-page/config.js
          echo ""
          
          # éå¸¸ã«ã‚·ãƒ³ãƒ—ãƒ«ãªç½®æ›æ–¹æ³•
          echo "ğŸ”„ ç½®æ›å®Ÿè¡Œä¸­..."
          cp support-page/config.js support-page/config.js.backup
          
          # ä¸€è¡Œãšã¤å‡¦ç†ã—ã¦ç½®æ›
          while IFS= read -r line; do
            if [[ "$line" == *"REPLACE_WITH_ACTUAL_WEBHOOK_URL"* ]]; then
              echo "    SLACK_WEBHOOK_URL: '$SLACK_WEBHOOK_URL',"
            else
              echo "$line"
            fi
          done < support-page/config.js.backup > support-page/config.js
          
          echo "=== ãƒ•ã‚¡ã‚¤ãƒ«ç½®æ›å¾Œ ==="
          head -5 support-page/config.js
          echo ""
          
          # ç½®æ›ãŒæˆåŠŸã—ãŸã‹ç¢ºèª
          if grep -q "REPLACE_WITH_ACTUAL_WEBHOOK_URL" support-page/config.js; then
            echo "âŒ ã‚¨ãƒ©ãƒ¼: ç½®æ›ãŒå®Œäº†ã—ã¦ã„ã¾ã›ã‚“"
            echo "--- ç½®æ›å¯¾è±¡ãŒè¦‹ã¤ã‹ã£ãŸè¡Œ ---"
            grep -n "REPLACE_WITH_ACTUAL_WEBHOOK_URL" support-page/config.js
            exit 1
          else
            echo "âœ… ç½®æ›æˆåŠŸï¼"
          fi
          
          # æœ€çµ‚ç¢ºèª
          echo "=== æœ€çµ‚ç¢ºèª ==="
          if grep -q "https://hooks.slack.com" support-page/config.js; then
            echo "âœ… Webhook URL ãŒæ­£ã—ãè¨­å®šã•ã‚Œã¦ã„ã¾ã™"
          else
            echo "âŒ Webhook URL ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“"
            echo "--- è¨­å®šè¡Œã®ç¢ºèª ---"
            grep -A 2 -B 2 "SLACK_WEBHOOK_URL" support-page/config.js
          fi
          
          # ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ãƒ•ã‚¡ã‚¤ãƒ«ã‚’å‰Šé™¤
          rm support-page/config.js.backup
      
      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: '.'

  deploy:
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    runs-on: ubuntu-latest
    needs: build
    steps:
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4 